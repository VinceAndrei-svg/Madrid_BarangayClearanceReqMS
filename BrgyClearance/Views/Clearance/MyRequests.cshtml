@model List<Proj1.Models.ViewModels.ClearanceRequestViewModel>

@{
ViewData["Title"] = "My Clearance Requests";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="bi bi-file-earmark-text"></i> My Clearance Requests
                </h2>
                <a asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> New Request
                </a>
            </div>

            @if (TempData["Success"] != null)
            {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i> @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            }

            @if (TempData["Error"] != null)
            {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            }

            @if (Model.Count == 0)
            {
            <div class="card text-center py-5">
                <div class="card-body">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Requests Yet</h4>
                    <p class="text-muted">You haven't submitted any clearance requests yet.</p>
                    <a asp-action="Create" class="btn btn-primary mt-2">
                        <i class="bi bi-plus-circle"></i> Submit Your First Request
                    </a>
                </div>
            </div>
            }
            else
            {
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th class="px-4">Reference #</th>
                                <th>Type</th>
                                <th>Purpose</th>
                                <th>Date Requested</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th class="text-end px-4">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var request in Model)
                            {
                            <tr>
                                <td class="px-4">
                                    <a asp-action="Details"
                                       asp-route-id="@request.Id"
                                       class="text-decoration-none fw-bold text-primary">
                                        @request.ReferenceNumber
                                    </a>
                                </td>

                                <td>
                                                <span class="badge bg-light text-dark border">
                                                    @request.ClearanceTypeName
                                                </span>
                                </td>

                                <td>
                                    <small class="text-muted">
                                        @(request.Purpose.Length > 40
                                        ? request.Purpose.Substring(0, 40) + "..."
                                        : request.Purpose)
                                    </small>
                                </td>

                                <td>
                                    <small class="text-nowrap">
                                        @request.RequestDate.ToLocalTime().ToString("MMM dd, yyyy")
                                    </small>
                                </td>

                                <td>
                                                <span class="badge @request.StatusBadgeClass">
                                                    @request.Status
                                                </span>
                                </td>

                                <td>
                                    @if (!string.IsNullOrEmpty(request.Remarks))
                                    {
                                    <small class="text-muted" title="@request.Remarks">
                                        @(request.Remarks.Length > 30
                                        ? request.Remarks.Substring(0, 30) + "..."
                                        : request.Remarks)
                                    </small>
                                    }
                                    else
                                    {
                                    <span class="text-muted">â€”</span>
                                    }
                                </td>

                                <td class="text-end px-4">
                                    <div class="btn-group" role="group">
                                        <a asp-action="Details"
                                           asp-route-id="@request.Id"
                                           class="btn btn-sm btn-outline-primary"
                                           title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>

                                        @if (request.Status == "Released")
                                        {
                                        <a asp-action="DownloadPdf"
                                           asp-route-id="@request.Id"
                                           class="btn btn-sm btn-success"
                                           title="Download PDF">
                                            <i class="bi bi-file-pdf"></i>
                                        </a>
                                        }

                                        @if (request.Status == "Submitted" || request.Status == "Pending")
                                        {
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#cancelModal-@request.Id"
                                                title="Cancel Request">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                        }
                                    </div>

                                    @if (request.Status == "Cancelled")
                                    {
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-info-circle"></i> Cancelled by you
                                    </div>
                                    }
                                </td>
                            </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Showing @Model.Count request@(Model.Count != 1 ? "s" : "")
                    </small>
                </div>
            </div>
            }
        </div>
    </div>
</div>

@if (Model.Count > 0)
{
@foreach (var request in Model.Where(r => r.Status == "Submitted" || r.Status == "Pending"))
{
<div class="modal fade"
     id="cancelModal-@request.Id"
     tabindex="-1"
     aria-labelledby="cancelModalLabel-@request.Id"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="Cancel"
                  method="post"
                  id="cancelForm-@request.Id"
                  novalidate>

                @Html.AntiForgeryToken()
                <input type="hidden" name="RequestId" value="@request.Id" />
                <input type="hidden" name="ReferenceNumber" value="@request.ReferenceNumber" />

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelModalLabel-@request.Id">
                        <i class="bi bi-exclamation-triangle"></i> Cancel Request?
                    </h5>
                    <button type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-file-earmark-text"></i> Request Details
                        </h6>
                        <dl class="row mb-0 small">
                            <dt class="col-5">Reference:</dt>
                            <dd class="col-7">@request.ReferenceNumber</dd>

                            <dt class="col-5">Type:</dt>
                            <dd class="col-7">@request.ClearanceTypeName</dd>

                            <dt class="col-5">Submitted:</dt>
                            <dd class="col-7 mb-0">
                                @request.RequestDate.ToLocalTime().ToString("MMM dd, yyyy")
                            </dd>
                        </dl>
                    </div>

                    <div class="alert alert-danger" role="alert">
                        <strong><i class="bi bi-exclamation-octagon"></i> Warning:</strong>
                        This action cannot be undone. Once cancelled, you will need to submit a new request.
                    </div>

                    <div class="mb-3">
                        <label for="cancellationReason-@request.Id" class="form-label">
                            <strong>Reason for cancellation</strong>
                            <span class="text-danger">*</span>
                        </label>
                        <textarea id="cancellationReason-@request.Id"
                                  name="Reason"
                                  class="form-control"
                                  rows="4"
                                  required
                                  minlength="10"
                                  maxlength="500"
                                  placeholder="Please explain why you're cancelling this request (minimum 10 characters)..."></textarea>

                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                This helps us improve our services
                            </small>
                            <small class="text-muted">
                                <span id="charCount-@request.Id">0</span>/500
                            </small>
                        </div>

                        <div class="invalid-feedback">
                            Please provide a reason (minimum 10 characters).
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> No, Keep Request
                    </button>
                    <button type="submit"
                            class="btn btn-danger"
                            id="confirmCancelBtn-@request.Id">
                        <i class="bi bi-check-circle"></i> Yes, Cancel Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
}
}

@section Scripts {
<script>
    setTimeout(function() {
        $('.alert-success').fadeOut('slow');
    }, 5000);

    $('textarea[name="Reason"]').on('input', function() {
        var requestId = $(this).closest('.modal').attr('id').split('-')[1];
        var charCount = $(this).val().length;
        $('#charCount-' + requestId).text(charCount);

        if (charCount >= 10 && charCount <= 500) {
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else if (charCount > 0) {
            $(this).removeClass('is-valid').addClass('is-invalid');
        } else {
            $(this).removeClass('is-valid is-invalid');
        }
    });

    $('form[id^="cancelForm-"]').on('submit', function(e) {
        var form = $(this);
        var textarea = form.find('textarea[name="Reason"]');
        var reason = textarea.val().trim();
        var submitBtn = form.find('button[type="submit"]');

        if (reason.length < 10) {
            e.preventDefault();
            textarea.addClass('is-invalid');
            textarea.focus();
            return false;
        }

        if (reason.length > 500) {
            e.preventDefault();
            textarea.addClass('is-invalid');
            alert('Cancellation reason is too long. Maximum 500 characters.');
            textarea.focus();
            return false;
        }

        submitBtn.prop('disabled', true);
        submitBtn.html(
            '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Cancelling...'
        );

        form.find('button[data-bs-dismiss="modal"]').prop('disabled', true);
        return true;
    });

    $('.modal').on('hidden.bs.modal', function() {
        var form = $(this).find('form');
        form[0].reset();
        form.find('textarea').removeClass('is-valid is-invalid');
        form.find('button[type="submit"]').prop('disabled', false).html(
            '<i class="bi bi-check-circle"></i> Yes, Cancel Request'
        );
        form.find('button[data-bs-dismiss="modal"]').prop('disabled', false);

        var requestId = $(this).attr('id').split('-')[1];
        $('#charCount-' + requestId).text('0');
    });

    $('.modal[data-bs-backdrop="static"]').on('click', function(e) {
        if ($(e.target).hasClass('modal')) {
            $(this).find('.modal-dialog').addClass('animate__animated animate__headShake');
            setTimeout(function() {
                $('.modal-dialog').removeClass('animate__animated animate__headShake');
            }, 1000);
        }
    });
</script>
}
